package com.mystudy.jdbc_dao;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

//DAO, Dao : Data Access Object / Database Access Object
//데이터(데이터베이스-DB)와 연동해서 CRUD를 구현한 클래스

//JDBC를 이용한 DB 프로그래밍 절차 ------------------
//0. JDBC 라이브러리 개발환경 설정(빌드경로에 등록)         >    JavaProject Build path에서 jar odbc등록
//1. JDBC 드라이버 로딩                                                             >   Class.forName(classname);
//2. DB연결  - Connection 객체 생성 <-DriverManager    >   DriverManager.getConnection(URL, USER, PASSWORD);
//3. Statement문 실행(SQL문 실행)                     >   conn.prepareStatement(sql); (psmt)    /   pstmt.executeQuery();
//4. SQL 실행 결과에 대한 처리                                                    > rs.getString(column_name)
// -SELECT : 조회(검색) 데이타 결과 값에 대한 처리
// -INSERT, UPDATE, DELETE : int값(건수) 처리
//5. 클로징 처리에 의한 자원 반납                                                 > JDBC_Close.closeConnectionStmtRs(conn, pstmt, rs);
//============================================
public class MemberDAO {
	private static final String IP = "localhost";
	private static final String DRIVER = "oracle.jdbc.OracleDriver";
	
	private static final String URL = "jdbc:oracle:thin:@"+ IP + ":1521:xe";
	private static final String USER = "mystudy";
	private static final String PASSWORD = "MYSTUDY";
	
	private Connection conn;
	private PreparedStatement pstmt;
	private ResultSet rs;
	
	//드라이버 로딩처리
	//static 초기화 구문
	static {
		try {
			//1. JDBC 드라이버 로딩
			Class.forName(DRIVER);
			System.out.println(">> JDBC 드라이버 로딩 성공");
		} catch (ClassNotFoundException e) {
			e.printStackTrace();
			System.out.println(">> JDBC 드라이버 로딩 실패");
		}
		
		
		}
	
	//SELECT : 테이블 전체 데이터 조회 - selectAll : List<MemberVO>
	//SELECT : 하나의 데이터 조회(ID) - selectOne : MemberVO
	//SELECT : 하나의 데이터 조회(VO) - selectOne : MemberVO
	//INSERT : VO 객체를 받어서 입력 - insertOne : int
	//UPDATE : VO 객체를 받어서 수정 - updateOne : int
	//DELETE : VO 객체를 받어서 삭제 - deleteOne : int
	//DELETE : 키값(id) 받아서 삭제 - deleteOne : int
	
	//로그인처리 : id, password 값을 받아서 동일한 데이터가 있으면 true
	//	                없으면 false리턴
	//boolean checkIdPassword(id,password)
	//---------------------------------------------------
	
	
	
	
	
	//SELECT : 테이블 전체 데이터 조회 - selectAll : List<MemberVO>
	public List<MemberVO> selectAll() {
		List<MemberVO> list = new ArrayList<MemberVO>();
		//2. DB연결  - Connection 객체 생성 <-DriverManager
		try {
			conn = DriverManager.getConnection(URL, USER, PASSWORD);
			
			//3. Statement문 실행(SQL문 실행)  
			StringBuilder sql = new StringBuilder();
			sql.append("SELECT ID, NAME, PASSWORD, PHONE, ADDRESS ");
			sql.append("FROM MEMBER ");
			sql.append("ORDER BY ID ");
			
			System.out.println("sql.toString() : " + sql.toString());
			pstmt = conn.prepareStatement(sql.toString());
			
			rs = pstmt.executeQuery();
			
			while(rs.next()) {
				/*
				MemberVO mvo = new MemberVO(
						rs.getString("ID"),
						rs.getString("NAME"),
						rs.getString("PASSWORD"),
						rs.getString("PHONE"),
						rs.getString("ADDRESS") );
				list.add(mvo);
				*/
				list.add(new MemberVO(rs.getString("ID"),
						rs.getString("NAME"),
						rs.getString("PASSWORD"),
						rs.getString("PHONE"),
						rs.getString("ADDRESS") ));
							
			}
		} catch (SQLException e) {
			e.printStackTrace();
		} finally {
			//사용한 객체 close
			JDBC_Close.closeConnectionStmtRs(conn, pstmt, rs);
			
		}
		
		
		
		return list;
	}
	
	//INSERT : VO 객체를 받어서 입력 - insertOne : int
	public int insertOne(MemberVO member) {
		int result = 0;
		try {
			conn = DriverManager.getConnection(URL, USER, PASSWORD);
			
			//SQL문장을 작성해서 Statement에 전달하고 sql문 실행 요청
			StringBuilder sql = new StringBuilder();
			sql.append("INSERT INTO MEMBER");
			sql.append("     (ID, NAME, PASSWORD, PHONE, ADDRESS)");
			sql.append("VALUES(?,?,?,?,?) ");
			pstmt = conn.prepareStatement(sql.toString());
			
			//?(Q바인딩변수)에 저장시키기
			pstmt.setString(1, member.getId());
			pstmt.setString(2, member.getName());
			pstmt.setString(3, member.getPassword());
			pstmt.setString(4, member.getPhone());
			pstmt.setString(5, member.getAddress());
			
			System.out.println("sql.toString() : " + sql.toString());
			result = pstmt.executeUpdate();
			
			
		} catch (SQLException e) {
			e.printStackTrace();
		} finally {
			JDBC_Close.closeConnStmtRs(conn, pstmt);
		}
		return result;
	}

	
	//로그인처리 : id, password 값을 받아서 동일한 데이터가 있으면 true
	//	                없으면 false리턴
	//boolean checkIdPassword(id,password)
	public boolean checkIdPassword(String id, String password) {
		boolean result = false;
		
		
		try {
			conn = DriverManager.getConnection(URL, USER, PASSWORD);
			
			//3. Statement문 실행(SQL문 실행)  
			StringBuilder sql = new StringBuilder();
			sql.append("SELECT ID, NAME, PASSWORD, PHONE, ADDRESS ");
			sql.append("FROM MEMBER ");
			sql.append("WHERE ID = ? AND PASSWORD = ? ");
			pstmt = conn.prepareStatement(sql.toString());
			
			pstmt.setString(1, id);
			pstmt.setString(2, password);
			
			System.out.println("sql.toString() : " + sql.toString());
			
			rs = pstmt.executeQuery();
			
			if(rs.next()) { //데이터가 있으면
				System.out.println(">> " + id + " 데이터 있음");
				result = true;
			}
			
		} catch (SQLException e) {
			e.printStackTrace();
		} finally {
			//사용한 객체 close
			JDBC_Close.closeConnectionStmtRs(conn, pstmt, rs);
			
		}
		
		return result;
	}

	
	public int insertMany(List<MemberVO> list) {
		int result = 0;
		try {
			conn = DriverManager.getConnection(URL, USER, PASSWORD);
			
			
			//SQL문장을 작성해서 Statement에 전달하고 sql문 실행 요청
			StringBuilder sql = new StringBuilder();
			sql.append("INSERT INTO MEMBER");
			sql.append("     (ID, NAME, PASSWORD, PHONE, ADDRESS)");
			sql.append(" VALUES(?,?,?,?,?)");
			pstmt = conn.prepareStatement(sql.toString());
			
			conn.setAutoCommit(false);
			for (MemberVO member : list) {
			
				//?(Q바인딩변수)에 저장시키기
				pstmt.setString(1, member.getId());
				pstmt.setString(2, member.getName());
				pstmt.setString(3, member.getPassword());
				pstmt.setString(4, member.getPhone());
				pstmt.setString(5, member.getAddress());
				
				System.out.println("sql.toString() : " + sql.toString());
				result += pstmt.executeUpdate();
				/*
				try {
					result += pstmt.executeUpdate();
					System.out.println("> 입력성공 : " + member.getId());
				} catch (SQLException e) {
					System.out.println("> 입력실패 : " + member.getId());
				}
				*/
			}
			conn.commit(); // 입력데이터 commit처리
			conn.setAutoCommit(true); // autocommit 상태로 전환
		} catch (SQLException e) {
			try {
				result = 0;
				conn.rollback(); // 전체데이터 롤백처리
				conn.setAutoCommit(true); // autocommit 상태로 전환
			} catch (SQLException e1) {
				e1.printStackTrace();
			}
		} finally {
			JDBC_Close.closeConnStmtRs(conn, pstmt);
		}
		
		return result;
	}

	
	//(실습) 일괄 삭제 : 삭제목록(list)을 받아서 일괄 삭제 처리 
	public int deleteList(List<MemberVO> list) {
		int result = 0;
		
		try {
			conn = DriverManager.getConnection(URL, USER, PASSWORD);
			
			
			//SQL문장을 작성해서 Statement에 전달하고 sql문 실행 요청
			StringBuilder sql = new StringBuilder();
			sql.append("DELETE FROM MEMBER ");
			sql.append("WHERE NAME = ? ");
			pstmt = conn.prepareStatement(sql.toString());
			
			for (MemberVO member : list) {
			
				//?(Q바인딩변수)에 저장시키기
				pstmt.setString(1, member.getName());
				System.out.println("sql.toString() : " + sql.toString());
				result += pstmt.executeUpdate();
			}
		} catch (SQLException e) {
				e.printStackTrace();
		} finally {
			JDBC_Close.closeConnStmtRs(conn, pstmt);
		}
		
		
		return result ;
	}
	
	
	
}
